<!doctype html>
<html lang="en">
<head>
  {% load staticfiles %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manual Mapping example</title>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <!--<link rel="stylesheet" href="/resources/demos/style.css">-->
  <style>
  html,body { 
    height:100%;
    margin: 0;
    padding: 0;
    font: Arial;
  }

  #wrapper{
    width: 80%;
    margin: 0 auto;
  }

  .heading_mapping, p {
    display: inline;
  }

  .heading_template{
    /*font-size: 4vw;*/
    /*max-width: 100px;*/
  }

  .heading_template_section {
    border: 1px solid black;
    border-radius: 5px;
    float: left;
    height: 120%;
    width: 30%;
    font-size: 153%
  }

  .heading_mapping_section{
    border: 1px solid black;
    border-radius: 5px;
    width: 70%;
    margin-left: 30%;
    height: 120%;
  }

  .heading_mapping{
     border: 1px solid black;
     font-size: 153%;
  }

  .heading_mapping:hover{
    text-indent: -9999px;
    background: blue !important;
  }

  .heading_section {
    clear: both;
    /*border: 1px solid black;
    border-radius: 5px;*/
  }
  /*#snapcontainer {
    border: 1px solid black;
    border-radius: 5px;
    margin: 0;
    padding: 0;
    height: 100%; 
    width :60%;
    float: left;
  }*/

  /*<#heading_section {
    border: 1px solid black;
    border-radius: 5px;
    margin: 0;
    padding: 0;
    display: inline-block;
  }*/

  #submit_button {
    clear : both;
  }
  
  /*.ui-widget-content {  
    height: 10%; 
    width :20%;
    float: left; 
  }
  
  .ui-widget-header{
    height: 10%; 
    width :20%;
    float: left;
  }*/

  .color {
    background-color: yellow;
  }

  .tl-selected{
    background: white;
    border:3px solid orange;
    width:179px;
    height:80px;
    position: relative;
}


  </style>
  <script src="{% static "jquery-3.1.1.js" %}"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script type="text/javascript">
  var dict = {"null":"null" {% for heading in remaining_headings %} ,"{{heading}}": ""{% endfor %} };
  var reverse_dict = {"null" : "null" {% for heading in missing_headings %} ,"{{heading}}": ""{% endfor %} };

  function perform_map(elem_id){
    var element = document.getElementById(elem_id);
    var ids = elem_id.split("|");
    var old_element = "";
    /*alert("heading_template: " + ids[0]);
    alert("heading_mapping: " + ids[1]);
    alert("dict: " + dict[ids[0]]);
    alert("reverse_dict: " + reverse_dict[ids[1]]);*/

    if(dict[ids[0]] != "" ){//template headings
      /*alert("here");
      alert("heading_template: " + ids[0]);
      alert("heading_mapping: " + ids[1]);
      alert("dict["+ ids[0] + "] " + dict[ids[0]]);
      alert("reverse_dict[" + dict[ids[0]] + "] "+ reverse_dict[dict[ids[0]]]);*/
      //alert("reverse_dict: " + reverse_dict[ids[1]]);
      old_element = document.getElementById(ids[0] + "|" + dict[ids[0]]);
      //alert(ids[0] + "|" + dict[ids[0]]);
      old_element.style.backgroundColor = "white";
      reverse_dict[dict[ids[0]]] = "";
      
      dict[ids[0]] = "";
      //alert(dict[ids[0]]);
      //what is it mapped to
    }
      //reverse_dict[dict[ids[0]]] = "";
    if(reverse_dict[ids[1]] != ""){//mapping_ headings
      /*alert("here2");
      alert("heading_template: " + ids[0]);
      alert("heading_mapping: " + ids[1]);
      alert("dict[" + reverse_dict[ids[1]] + "] " + dict[reverse_dict[ids[1]]]);
      alert("reverse_dict[" + ids[1]+ "] " + reverse_dict[ids[1]]);*/
      old_element = document.getElementById(reverse_dict[ids[1]] + "|" + dict[reverse_dict[ids[1]]]);
      //old_element = document.getElementById(reverse_dict[ids[1]] + "|" + ids[1]);
      //alert(reverse_dict[ids[1]] + "|" + ids[1]);
      old_element.style.backgroundColor = "white";
      dict[reverse_dict[ids[1]]] = "";
      reverse_dict[ids[1]] = "";
      //dict[reverse_dict[ids[1]]] = "";
    }
      //change reverse dict to blank
      //chaange current one
      //check that new one is not assigned
      //if so remove coolouring

    //alert()
    reverse_dict[ids[1]] = ids[0];
    dict[ids[0]] = ids[1];
    element.style.backgroundColor = "yellow";
  
  }

  /*$(".heading_mapping").click(function() {
    $(this).css("background-color", "red"); 
  });*/
  /*$( function() {
    dragged_element = "";
    dropped_element = "";
    
    $( ".ui-widget-content" ).draggable({ 
      start:function(e){
        dragged_element = e.target.id;
      },
      snap: ".ui-widget-header"
    });
    $( ".ui-widget-header" ).droppable({//allow only one heading to be drpped
      drop: function( event, ui ) {
        dropped_element = event.target.id;
        if (dict[dropped_element] != "" || dict[dropped_element] != dragged_element) { $("#" + dict[dropped_element] ).animate({ top: '230px' });} 
        dict[dropped_element] = dragged_element;
        $( this )
          .addClass( "ui-state-highlight" )
          .find( "p" )
          .html( "Mapped " + event.target.id  );    
      },
      over: function (event, ui) {
        //if (dict[dropped_element] == "") {
          $( this )
          .addClass( "ui-state-highlight" )
          .find( "p" )
          .html( "Mapping " + event.target.id );
        //}
      },
      out: function (event, ui) {
        if(dict[dropped_element] == dragged_element || dict[dropped_element] == ""){
            dict[event.target.id] = "";
            $( this )
            .removeClass('ui-state-highlight')
            .find( "p" )
            .html( event.target.id );
        }
      }
      
    });
  } );*/

  function check_complete_mapping(){
      var check = true
      for (var key in dict) {
        //alert(key);
        if( dict[key] == "" ) {
            check = false
            alert("Mapping incomplete");
            return false;
        }
      }
      if (check){
        send_mapping_data(dict);
      }      
      return true
  }

    //send post request
  function send_mapping_data(data){
    /*$.post("manual_mapping", data, function(response){
      if(response === 'success'){ alert('Yay!'); }
      else{ alert('Error! :('); }
    });*/

    var json_string = JSON.stringify(dict);
    $('#dict').val( json_string );
    //$.post( "manual_mapping", data );//where is this being sent, what field in post is it going to???
  }

  </script>
</head>

<body>
<div id="wrapper">
<h1>ZOOM</h1>
<form action="{{ request.build_absolute_uri }}" method="post" enctype="multipart/form-data" onsubmit="return check_complete_mapping()";>
  {% csrf_token %}
       
    <div id = "targets">
      {% for heading_template in remaining_headings %}
        <div id="{{heading_template}}" class="heading_section">
            <div class="heading_template_section">
              <p>{{heading_template}}</p>
            </div>
            <div class="heading_mapping_section">
            {% for heading_mapping in missing_headings %}
              <div id="{{heading_template}}|{{heading_mapping}}" class="heading_mapping" onclick="perform_map('{{heading_template}}|{{heading_mapping}}')">
                <p>{{heading_mapping}}</p>
              </div>
            {% endfor %}
            </div>
          
       </div>
      {% endfor %}
    </div> 
    <input id="dict" type="hidden" name="dict" value="">
    <div id ="submit_button"><p><input type="submit" name="map" value="map" onclick="" /></p></div>
</form>
</div>
</body>
</html>