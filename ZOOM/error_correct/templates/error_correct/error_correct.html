{% load staticfiles %}

  <!DOCTYPE html>
  <html>
    <head>
      <!--Import Google Icon Font-->
      <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="{% static 'css/materialize.min.css' %}"  media="screen,projection"/>

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

      <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs/jq-2.2.4/dt-1.10.13/datatables.min.css"/>
      <style>
      table, th, td {
         border: 1px solid #ddd;
      }
      td:focus {
        -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 6px #7ab5d3;
        -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 6px #7ab5d3;
        box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 6px #7ab5d3;  
        outline: rgb(91, 157, 217) auto 5px;
      }
      </style>

       

    </head>


      <div class="container">
      <h1>File Errors Management</h1>


      <form action="{{ request.build_absolute_uri }}../validate/" method="POST"  enctype="multipart/form-data" onsubmit="return send_data();" id="table_form" class="col s10 offset-2" >
      {% csrf_token %}
      <div id="table" class="table-editable">
        <span class="table-add glyphicon glyphicon-plus"></span>
        <table id="myTab" class="table striped">
          <thead>
            <tr>
            <th>Item</th>
            {% for data in column_headings %}
                <th>{{data}}</th>
            {% endfor %}
                <th>Delete</th>
            </tr>
          </thead>
            
          <tbody>
            {% for line_no, data_line in df_data %}
            <tr>
                <td >{{line_no}}</td>
                {% for data, error_id in data_line %}
                    <td contenteditable="true" id="{{error_id}}">{{data}}</td>
                {% endfor %}
                <td></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
          <div class="mdl-card__actions mdl-card--border">
            <input type="submit" name="" class="waves-effect waves-light btn" value="Validate">
          </div>
      </div>
      <input id="dict" type="hidden" name="dict" value="">
      </form>
      </div>


      <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
      <script type="text/javascript" src="{% static 'js/materialize.min.js' %}"></script>
      <script type="text/javascript" src="https://cdn.datatables.net/v/bs/jq-2.2.4/dt-1.10.13/datatables.min.js"></script>


      <script>
        var send_data = {};
        // var $headers = $("th");
        // $headers.each(function(Index){
        //   console.log($($headers[Index]).html())
        // });

        var extract_data = function(){
          var myObj = {};
          var myRows = [];
          var $headers = $("th");
          var $rows = $("tbody tr").each(function(index) {
            $cells = $(this).find("td");
            myRows[index] = {};
            $cells.each(function(cellIndex) {
              myRows[index][$($headers[cellIndex]).html()] = $(this).html();
            });    
          });
          myObj.myrows = myRows;
          return myObj
        };

        var find_row_id = function(line_no){
          for(i=0; i<send_data.myrows.length; i++){
            if (send_data.myrows[i].Item === line_no){
              return i;
            }  
          }
          return -1;
        };


       
        $(document).ready(function() {
            {% for id, message in found_error_ids %}
            $('#{{id}}').css('background','red')
            {% endfor %}

            send_data = extract_data();
            // console.log(send_data);

            setTimeout(function(){
             $("#1_Indicator").focus();
            }, 1);

            $('#myTab')
            .on('stateLoaded.dt',   function () { eventFired( 'state' ); } )
            .DataTable({
              "searching":   false,
              "ordering": false
            });

            var table = $('#myTab').DataTable();
 
            table.on( 'page', function () {
                var new_data = {};
                new_data = extract_data();

                for (var i = 0; i < new_data.myrows.length; i++){
                    var new_data_line_no = new_data.myrows[i]["Item"];
                    var send_data_id = find_row_id(new_data_line_no);
                    var $headers = $("th");
                    $headers.each(function(Index) {
                      send_data.myrows[send_data_id][$($headers[Index]).html()] = new_data.myrows[i][$($headers[Index]).html()];
                    });
                }
                // console.log(send_data);
            } );

            table.on( 'length', function () {
                var new_data = {};
                new_data = extract_data();
                for (var i = 0; i < new_data.myrows.length; i++){
                    var new_data_line_no = new_data.myrows[i]["Item"];
                    var send_data_id = find_row_id(new_data_line_no);
                    var $headers = $("th");
                    $headers.each(function(Index) {
                      send_data.myrows[send_data_id][$($headers[Index]).html()] = new_data.myrows[i][$($headers[Index]).html()];
                    });
                }
                // console.log(send_data);
            } );
        });

      </script>

      <script type="text/javascript">
        //function send_data(){
        $(document).on('submit', '#table_form', function(e){
          //e.preventDefault();
          // var myRows = [];
          // var $headers = $("th");
          // var $rows = $("tbody tr").each(function(index) {
          //   $cells = $(this).find("td");
          //   myRows[index] = {};
          //   $cells.each(function(cellIndex) {
          //     myRows[index][$($headers[cellIndex]).html()] = $(this).html();
          //   });    
          // });

          // var myObj = {};
          // myObj.myrows = myRows;

          var new_data = {};
          new_data = extract_data();
          for (var i = 0; i < new_data.myrows.length - 1; i++){
              var new_data_line_no = new_data.myrows[i]["Item"];
              var send_data_id = find_row_id(new_data_line_no);
              var $headers = $("th");
              $headers.each(function(Index) {
                send_data.myrows[send_data_id][$($headers[Index]).html()] = new_data.myrows[i][$($headers[Index]).html()];
              });
          }
          alert(send_data);
          var data = JSON.stringify(send_data);
          $('#dict').val(data);
          //window.location.assign("/validate/");

          return true;
          /*console.log(data);

          $.ajax({
            type:'POST',
            url:'/validate/report/',
            data:{
              data : data,
              dict : "True",
              csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
            },
            success:function(){
              console.log(window.location.href);
              window.location.assign("/validate/report_update/{{newdoc_name}}");
              // alert(window.location.href);
                // alert("OK");
            },
            // error:function(){
            //   alert("NOK");
            // },
          });*/
        });
      </script>

    </body>
  </html>