{% load staticfiles %}

  <!DOCTYPE html>
  <html>
    <head>
      <!--Import Google Icon Font-->
      <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="{% static 'css/materialize.min.css' %}"  media="screen,projection"/>

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    </head>


      <div class="container">
      <h1>File Errors Management</h1>


      <form id="table_form" class="col s10 offset-2">{% csrf_token %}
      <div id="table" class="table-editable"">
        <span class="table-add glyphicon glyphicon-plus"></span>
        <table class="table striped">
          <thead>
            <tr>
            <th>Line No.</th>
            {% for data in column_headings %}
                <th>{{data}}</th>
            {% endfor %}
                <th>Delete</th>
            </tr>
          </thead>
            
          <tbody>
            {% for line_no, data_line in df_data %}
            <tr>
                <td >{{line_no}}</td>
                {% for data, error_id in data_line %}
                    <td contenteditable="true" id="{{error_id}}">{{data}}</td>
                {% endfor %}
                <td></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
          <div class="mdl-card__actions mdl-card--border">
            <input type="submit" name="" class="waves-effect waves-light btn" value="Save">
          </div>
      </div>
      </form>
  
<!--       <button id="export-btn" class="btn btn-primary">Export Data</button>
      <p id="export"></p>
      </div> -->

      <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
      <script type="text/javascript" src="{% static 'js/materialize.min.js' %}"></script>

      <script>
        $(document).ready(function() {
            {% for id, message in found_error_ids %}
            $('#{{id}}').css('background','red')
            {% endfor %}
        } );

      </script>

      <script type="text/javascript">
        var $TABLE = $('#table');
        var $BTN = $('#export-btn');
        var $EXPORT = $('#export');

        $('.table-add').click(function () {
          var $clone = $TABLE.find('tr.hide').clone(true).removeClass('hide table-line');
          $TABLE.find('table').append($clone);
        });

        $('.table-remove').click(function () {
          $(this).parents('tr').detach();
        });

        $('.table-up').click(function () {
          var $row = $(this).parents('tr');
          if ($row.index() === 1) return; // Don't go above the header
          $row.prev().before($row.get(0));
        });

        $('.table-down').click(function () {
          var $row = $(this).parents('tr');
          $row.next().after($row.get(0));
        });

        // A few jQuery helpers for exporting only
        jQuery.fn.pop = [].pop;
        jQuery.fn.shift = [].shift;

        $BTN.click(function () {
          var $rows = $TABLE.find('tr:not(:hidden)');
          var headers = [];
          var data = [];
          
          // Get the headers (add special header logic here)
          $($rows.shift()).find('th:not(:empty)').each(function () {
            headers.push($(this).text().toLowerCase());
          });
          
          // Turn all existing rows into a loopable array
          $rows.each(function () {
            var $td = $(this).find('td');
            var h = {};
            
            // Use the headers from earlier to name our hash keys
            headers.forEach(function (header, i) {
              h[header] = $td.eq(i).text();   
            });
            
            data.push(h);
          });
          
          // Output the result
          $EXPORT.text(JSON.stringify(data));
        });

      </script>

      
      <script type="text/javascript">
        $(document).on('submit', '#table_form', function(e){
          e.preventDefault();

          var myRows = [];
          var $headers = $("th");
          var $rows = $("tbody tr").each(function(index) {
            $cells = $(this).find("td");
            myRows[index] = {};
            $cells.each(function(cellIndex) {
              myRows[index][$($headers[cellIndex]).html()] = $(this).html();
            });    
          });

          var myObj = {};
          myObj.myrows = myRows;

          var data = JSON.stringify(myObj);
          console.log(data);

          $.ajax({
            type:'POST',
            url:'/validate/',
            data:{
              data : data,
              csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
            },
            success:function(){
              console.log(window.location.href);
              window.location.assign("http://dev-zoom.zz-clients.net/validate/");
              // alert(window.location.href);
                // alert("OK");
            },
            // error:function(){
            //   alert("NOK");
            // },
          });
        });
      </script>

    </body>
  </html>